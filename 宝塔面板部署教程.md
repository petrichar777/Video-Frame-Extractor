# 宝塔面板部署教程

## 🎯 部署架构

- **前端**: 宝塔面板网站 (端口5221)
- **后端**: Java应用 (端口8080)
- **服务器IP**: 159.75.236.29

## 📋 准备工作

### 1. 确保宝塔面板已安装
```bash
# 如果未安装宝塔面板，执行以下命令
wget -O install.sh http://download.bt.cn/install/install-ubuntu_6.0.sh && sudo bash install.sh
```

### 2. 安装必要的软件
在宝塔面板中安装以下软件：
- **Nginx** (用于前端网站)
- **Java项目管理器** 或 **PM2管理器** (用于后端)
- **防火墙** (端口管理)

## 🌐 前端部署 (端口5221)

### 步骤1: 创建网站

1. **登录宝塔面板**
   - 访问: `http://159.75.236.29:8888`
   - 输入用户名和密码

2. **添加站点**
   - 点击 `网站` → `添加站点`
   - **域名**: `159.75.236.29:5221`
   - **根目录**: `/www/wwwroot/video-processor-frontend`
   - **PHP版本**: 纯静态 (不需要PHP)
   - 点击 `提交`

### 步骤2: 上传前端文件

1. **通过宝塔文件管理器**
   - 点击 `文件`
   - 进入 `/www/wwwroot/video-processor-frontend`
   - 上传 `Front` 文件夹中的所有文件：
     - `index.html`
     - `script.js`
     - `style.css`

2. **或通过FTP/SFTP上传**
   ```bash
   scp -r Front/* root@159.75.236.29:/www/wwwroot/video-processor-frontend/
   ```

### 步骤3: 配置Nginx

1. **编辑网站配置**
   - 在网站列表中找到刚创建的站点
   - 点击 `设置`
   - 选择 `配置文件`

2. **修改Nginx配置**
   ```nginx
   server {
       listen 5221;
       server_name 159.75.236.29;
       index index.html;
       root /www/wwwroot/video-processor-frontend;
       
       # 静态文件处理
       location / {
           try_files $uri $uri/ /index.html;
       }
       
       # 静态资源缓存
       location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
           expires 1y;
           add_header Cache-Control "public, immutable";
       }
       
       # 安全头
       add_header X-Frame-Options "SAMEORIGIN" always;
       add_header X-Content-Type-Options "nosniff" always;
       add_header X-XSS-Protection "1; mode=block" always;
       
       # 日志文件
       access_log /www/wwwlogs/video-frontend.log;
       error_log /www/wwwlogs/video-frontend.error.log;
   }
   ```

3. **重载Nginx配置**
   - 点击 `保存`
   - 在 `软件商店` → `Nginx` → `重载配置`

### 步骤4: 开放端口

1. **在宝塔面板中开放端口**
   - 点击 `安全`
   - 添加端口规则：
     - **端口**: `5221`
     - **协议**: `TCP`
     - **策略**: `放行`
     - **备注**: `前端网站端口`

2. **检查系统防火墙**
   ```bash
   # 如果使用ufw
   sudo ufw allow 5221/tcp
   
   # 如果使用firewalld
   sudo firewall-cmd --permanent --add-port=5221/tcp
   sudo firewall-cmd --reload
   ```

## ☕ 后端部署 (端口8080)

### 方案1: 使用宝塔Java项目管理器 (推荐)

1. **安装Java项目管理器**
   - 在 `软件商店` 中搜索 `Java项目管理器`
   - 点击安装

2. **上传JAR文件**
   - 通过文件管理器上传 `video-frame-extractor-1.0.0.jar` 到 `/www/server/java-project/`

3. **添加Java项目**
   - 点击 `Java项目管理器`
   - 点击 `添加项目`
   - **项目名称**: `video-frame-extractor`
   - **项目路径**: `/www/server/java-project/video-frame-extractor-1.0.0.jar`
   - **启动端口**: `8080`
   - **JVM参数**: `-Xmx2g -Xms1g`
   - **启动参数**: `--spring.profiles.active=prod`
   - 点击 `提交`

4. **启动项目**
   - 在项目列表中点击 `启动`
   - 查看日志确认启动成功

### 方案2: 使用PM2管理器

1. **安装PM2管理器**
   - 在 `软件商店` 中安装 `PM2管理器`

2. **创建启动脚本**
   ```bash
   # 创建启动脚本
   cat > /www/server/java-project/start-backend.sh << 'EOF'
   #!/bin/bash
   cd /www/server/java-project
   java -Xmx2g -Xms1g -jar video-frame-extractor-1.0.0.jar --spring.profiles.active=prod
   EOF
   
   # 设置执行权限
   chmod +x /www/server/java-project/start-backend.sh
   ```

3. **在PM2中添加项目**
   - 点击 `PM2管理器`
   - 点击 `添加项目`
   - **项目名称**: `video-backend`
   - **启动文件**: `/www/server/java-project/start-backend.sh`
   - **运行目录**: `/www/server/java-project`
   - 点击 `提交`

### 方案3: 手动部署 (系统服务)

1. **上传JAR文件**
   ```bash
   scp target/video-frame-extractor-1.0.0.jar root@159.75.236.29:/opt/video-processor/
   ```

2. **创建系统服务**
   ```bash
   # 创建服务文件
   sudo tee /etc/systemd/system/video-backend.service > /dev/null <<EOF
   [Unit]
   Description=Video Frame Extractor Backend
   After=network.target
   
   [Service]
   Type=simple
   User=root
   WorkingDirectory=/opt/video-processor
   ExecStart=/usr/bin/java -Xmx2g -Xms1g -jar video-frame-extractor-1.0.0.jar --spring.profiles.active=prod
   Restart=always
   RestartSec=10
   
   [Install]
   WantedBy=multi-user.target
   EOF
   
   # 启动服务
   sudo systemctl daemon-reload
   sudo systemctl enable video-backend
   sudo systemctl start video-backend
   ```

### 开放后端端口

1. **在宝塔面板中开放8080端口**
   - 点击 `安全`
   - 添加端口规则：
     - **端口**: `8080`
     - **协议**: `TCP`
     - **策略**: `放行`
     - **备注**: `后端API端口`

## 🔧 生产环境配置

### 1. 创建生产环境配置文件

在宝塔文件管理器中创建 `/www/server/java-project/application-prod.yml`：

```yaml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  servlet:
    multipart:
      max-file-size: 1GB
      max-request-size: 1GB
  profiles:
    active: prod

logging:
  level:
    com.videoprocessor: INFO
    org.bytedeco: WARN
  file:
    name: /www/wwwlogs/video-backend.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

video:
  processor:
    temp-dir: /tmp/video-processor
    max-duration: 7200
    supported-formats: mp4,avi,mov,mkv,wmv,flv,webm
```

### 2. SSL证书配置 (可选)

1. **申请SSL证书**
   - 在宝塔面板中点击网站 `设置`
   - 选择 `SSL`
   - 选择 `Let's Encrypt` 或上传自有证书

2. **强制HTTPS**
   - 开启 `强制HTTPS`
   - 更新前端API地址为HTTPS

### 3. 域名配置 (可选)

如果有域名，可以配置域名访问：

1. **添加域名解析**
   - 在域名服务商处添加A记录指向 `159.75.236.29`

2. **修改网站配置**
   - 将网站域名改为实际域名
   - 更新前端API地址

## 📊 监控和维护

### 1. 查看网站状态

- **网站访问日志**: `/www/wwwlogs/video-frontend.log`
- **网站错误日志**: `/www/wwwlogs/video-frontend.error.log`
- **后端应用日志**: `/www/wwwlogs/video-backend.log`

### 2. 性能监控

1. **在宝塔面板中查看**
   - `监控` → `系统状态`
   - 查看CPU、内存、磁盘使用情况

2. **Java应用监控**
   - 在 `Java项目管理器` 中查看应用状态
   - 查看内存使用和GC情况

### 3. 定期维护

```bash
# 清理临时文件
sudo rm -rf /tmp/video-processor/*

# 清理日志文件 (保留最近7天)
find /www/wwwlogs -name "*.log" -mtime +7 -delete

# 重启服务 (如果需要)
sudo systemctl restart video-backend
```

## 🔍 故障排查

### 1. 前端无法访问

1. **检查Nginx状态**
   - 在宝塔面板 `软件商店` → `Nginx` → 查看状态

2. **检查端口是否开放**
   ```bash
   netstat -tlnp | grep 5221
   ```

3. **查看错误日志**
   ```bash
   tail -f /www/wwwlogs/video-frontend.error.log
   ```

### 2. 后端API无法访问

1. **检查Java应用状态**
   - 在 `Java项目管理器` 中查看应用状态

2. **检查端口监听**
   ```bash
   netstat -tlnp | grep 8080
   ```

3. **查看应用日志**
   ```bash
   tail -f /www/wwwlogs/video-backend.log
   ```

### 3. 跨域问题

如果出现跨域错误，检查：
1. 后端CORS配置是否正确
2. 前端API地址是否正确
3. 端口是否匹配

## ✅ 部署验证

### 1. 测试前端访问
```bash
curl http://159.75.236.29:5221
```

### 2. 测试后端API
```bash
curl http://159.75.236.29:8080/api/video/health
```

### 3. 测试完整功能
1. 在浏览器中访问 `http://159.75.236.29:5221`
2. 点击 `检查服务状态` 按钮
3. 上传视频文件测试功能

## 🎯 访问地址总结

- **前端网站**: http://159.75.236.29:5221
- **后端API**: http://159.75.236.29:8080/api
- **宝塔面板**: http://159.75.236.29:8888
- **健康检查**: http://159.75.236.29:8080/api/video/health

## 📝 注意事项

1. **备份重要数据**: 定期备份配置文件和数据
2. **安全设置**: 修改宝塔面板默认端口和密码
3. **防火墙配置**: 只开放必要的端口
4. **SSL证书**: 生产环境建议使用HTTPS
5. **监控告警**: 配置服务异常告警
6. **定期更新**: 保持系统和软件版本更新

## 🚀 优化建议

1. **CDN加速**: 将静态文件部署到CDN
2. **负载均衡**: 高并发时使用负载均衡
3. **数据库**: 如需持久化存储可添加数据库
4. **缓存**: 使用Redis缓存提高性能
5. **容器化**: 考虑使用Docker部署
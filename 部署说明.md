# 视频帧提取器部署说明

## 📦 打包结果

### 后端 JAR 文件
- **文件位置**: `target/video-frame-extractor-1.0.0.jar`
- **文件大小**: 约 200MB（包含所有依赖）
- **类型**: Spring Boot 可执行 JAR 文件
- **Java版本要求**: JDK 17 或更高版本

### 前端静态文件
- **文件位置**: `Front/` 目录
- **包含文件**: 
  - `index.html` - 主页面
  - `script.js` - JavaScript 逻辑
  - `style.css` - 样式文件
- **部署方式**: 直接部署静态文件，无需打包

## 🚀 后端部署

### 1. 服务器环境要求

```bash
# 检查 Java 版本
java -version
# 需要 Java 17 或更高版本
```

### 2. 部署步骤

**上传 JAR 文件到服务器：**
```bash
# 将 target/video-frame-extractor-1.0.0.jar 上传到服务器
scp target/video-frame-extractor-1.0.0.jar user@server:/opt/video-processor/
```

**启动应用：**
```bash
# 方式1：直接启动
java -jar video-frame-extractor-1.0.0.jar

# 方式2：后台启动
nohup java -jar video-frame-extractor-1.0.0.jar > app.log 2>&1 &

# 方式3：指定端口启动
java -jar video-frame-extractor-1.0.0.jar --server.port=8080

# 方式4：指定配置文件
java -jar video-frame-extractor-1.0.0.jar --spring.config.location=application.yml
```

### 3. 生产环境配置

**创建 application-prod.yml：**
```yaml
server:
  port: 8080
  servlet:
    context-path: /api

spring:
  servlet:
    multipart:
      max-file-size: 1GB
      max-request-size: 1GB
  profiles:
    active: prod

logging:
  level:
    com.videoprocessor: INFO
    org.bytedeco: WARN
  file:
    name: /var/log/video-processor/app.log
  pattern:
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"

video:
  processor:
    temp-dir: /tmp/video-processor
    max-duration: 7200
    supported-formats: mp4,avi,mov,mkv,wmv,flv,webm
```

**使用生产配置启动：**
```bash
java -jar video-frame-extractor-1.0.0.jar --spring.profiles.active=prod
```

### 4. 系统服务配置（推荐）

**创建 systemd 服务文件 `/etc/systemd/system/video-processor.service`：**
```ini
[Unit]
Description=Video Frame Extractor Service
After=network.target

[Service]
Type=simple
User=videoprocessor
WorkingDirectory=/opt/video-processor
ExecStart=/usr/bin/java -jar /opt/video-processor/video-frame-extractor-1.0.0.jar --spring.profiles.active=prod
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

# 环境变量
Environment=JAVA_OPTS="-Xmx2g -Xms1g"
Environment=SPRING_PROFILES_ACTIVE=prod

[Install]
WantedBy=multi-user.target
```

**启动服务：**
```bash
# 重载 systemd 配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start video-processor

# 设置开机自启
sudo systemctl enable video-processor

# 查看服务状态
sudo systemctl status video-processor

# 查看日志
sudo journalctl -u video-processor -f
```

### 5. 反向代理配置（Nginx）

**创建 Nginx 配置 `/etc/nginx/sites-available/video-processor`：**
```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    # 静态文件服务
    location / {
        root /var/www/video-processor-frontend;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 文件上传配置
        client_max_body_size 1G;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
```

**启用配置：**
```bash
sudo ln -s /etc/nginx/sites-available/video-processor /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 🌐 前端部署

### 方案1：直接部署静态文件（推荐）

**前端文件无需打包，直接部署：**
```bash
# 1. 上传前端文件到 Web 服务器
scp -r Front/* user@server:/var/www/video-processor-frontend/

# 2. 设置正确的权限
sudo chown -R www-data:www-data /var/www/video-processor-frontend/
sudo chmod -R 755 /var/www/video-processor-frontend/
```

**修改前端 API 地址：**
在 `script.js` 中修改 API 基础地址：
```javascript
// 开发环境
const API_BASE_URL = 'http://localhost:8080/api';

// 生产环境
const API_BASE_URL = 'https://your-domain.com/api';
// 或者使用相对路径
const API_BASE_URL = '/api';
```

### 方案2：使用 CDN 部署

**上传到 CDN 或对象存储：**
```bash
# 示例：上传到阿里云 OSS
ossutil cp -r Front/ oss://your-bucket/video-processor/
```

### 方案3：容器化部署

**创建 Dockerfile（前端）：**
```dockerfile
FROM nginx:alpine

# 复制前端文件
COPY Front/ /usr/share/nginx/html/

# 复制 Nginx 配置
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

**创建 nginx.conf：**
```nginx
server {
    listen 80;
    server_name localhost;
    
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
    
    # API 代理到后端服务
    location /api/ {
        proxy_pass http://backend:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## 🐳 Docker 部署（完整方案）

### 1. 后端 Dockerfile

**创建 `Dockerfile`：**
```dockerfile
FROM openjdk:17-jre-slim

# 安装 FFmpeg
RUN apt-get update && apt-get install -y ffmpeg && rm -rf /var/lib/apt/lists/*

# 创建应用目录
WORKDIR /app

# 复制 JAR 文件
COPY target/video-frame-extractor-1.0.0.jar app.jar

# 创建临时目录
RUN mkdir -p /tmp/video-processor

# 暴露端口
EXPOSE 8080

# 启动应用
ENTRYPOINT ["java", "-jar", "app.jar"]
```

### 2. Docker Compose 部署

**创建 `docker-compose.yml`：**
```yaml
version: '3.8'

services:
  backend:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
    volumes:
      - ./logs:/var/log/video-processor
      - /tmp/video-processor:/tmp/video-processor
    restart: unless-stopped
    
  frontend:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./Front:/usr/share/nginx/html
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - backend
    restart: unless-stopped

  nginx:
    image: nginx:alpine
    ports:
      - "443:443"
    volumes:
      - ./nginx-ssl.conf:/etc/nginx/conf.d/default.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
```

**启动服务：**
```bash
docker-compose up -d
```

## 🔧 性能优化建议

### 1. JVM 参数优化

```bash
java -Xmx4g -Xms2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 \
     -jar video-frame-extractor-1.0.0.jar
```

### 2. 系统参数优化

```bash
# 增加文件描述符限制
echo "* soft nofile 65536" >> /etc/security/limits.conf
echo "* hard nofile 65536" >> /etc/security/limits.conf

# 优化内核参数
echo "vm.swappiness=10" >> /etc/sysctl.conf
echo "net.core.somaxconn=65535" >> /etc/sysctl.conf
sysctl -p
```

### 3. 监控和日志

**安装监控工具：**
```bash
# 安装 htop 监控系统资源
sudo apt install htop

# 使用 jstat 监控 JVM
jstat -gc -t $(pgrep java) 5s
```

## 🔍 故障排查

### 常见问题

1. **端口被占用**
   ```bash
   # 查看端口占用
   netstat -tlnp | grep 8080
   # 或使用 lsof
   lsof -i :8080
   ```

2. **内存不足**
   ```bash
   # 查看内存使用
   free -h
   # 查看 Java 进程内存
   jmap -histo $(pgrep java)
   ```

3. **FFmpeg 依赖问题**
   ```bash
   # 安装 FFmpeg
   sudo apt update
   sudo apt install ffmpeg
   ```

4. **文件权限问题**
   ```bash
   # 检查临时目录权限
   ls -la /tmp/video-processor
   # 修改权限
   sudo chown -R $(whoami) /tmp/video-processor
   ```

### 日志查看

```bash
# 查看应用日志
tail -f /var/log/video-processor/app.log

# 查看系统服务日志
sudo journalctl -u video-processor -f

# 查看 Nginx 日志
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

## 📋 部署检查清单

### 后端部署检查
- [ ] Java 17+ 环境已安装
- [ ] JAR 文件已上传到服务器
- [ ] 端口 8080 可访问
- [ ] FFmpeg 依赖已安装
- [ ] 临时目录权限正确
- [ ] 系统服务配置完成
- [ ] 日志目录创建
- [ ] 防火墙规则配置

### 前端部署检查
- [ ] 静态文件已上传
- [ ] Web 服务器配置正确
- [ ] API 地址已更新
- [ ] CORS 配置正确
- [ ] SSL 证书配置（生产环境）
- [ ] CDN 配置（如需要）

### 测试验证
- [ ] 后端健康检查：`curl http://your-domain.com/api/video/health`
- [ ] 前端页面访问：`http://your-domain.com`
- [ ] 文件上传功能测试
- [ ] API 接口功能测试
- [ ] 跨域请求测试

## 🎯 总结

**后端部署**：
- ✅ 已打包为可执行 JAR 文件
- ✅ 包含所有依赖，直接运行即可
- ✅ 支持多种部署方式（直接运行、系统服务、Docker）

**前端部署**：
- ✅ 无需打包，直接部署静态文件
- ✅ 只需修改 API 地址配置
- ✅ 支持多种部署方式（Nginx、CDN、Docker）

**推荐部署架构**：
```
用户 → Nginx (反向代理) → 后端 JAR (8080端口)
     ↓
   静态文件服务 (前端)
```

现在您可以根据实际需求选择合适的部署方案！